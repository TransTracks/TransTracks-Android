name: Update Auto-merge Queue

env:
  BUILD_NUMBER: ${{ github.run_number }}

on:
  pull_request:
    types: [auto_merge_enabled]
  push:

jobs:

  get-prs:
    runs-on: ubuntu-latest

    steps:
      - name: 🚚 Checkout PR
        uses: actions/checkout@v3

      - name: 📝 Get open prs
        id: prs
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          API_URL: https://api.github.com/repos/${{ github.repository }}/pulls?state=open
        run: |
          prListRequest=$(curl -s -H "Authorization: Bearer $TOKEN" "$API_URL")
          prList=$(echo "$prListRequest" | jq --raw-output '.items')
          echo "pr_list='$prList'" >> "$GITHUB_OUTPUT"

      - name: Filter to those with automerge details
        env:
          PR_LIST_JSON: ${{ steps.prs.outputs.pr_list }}
        run: |
          autoMergePrList=$(echo "$PR_LIST_JSON" | jq -c 'select(.item | select( .auto_merge ))')
          echo "automerge_pr_list=$autoMergePrList" >> "$GITHUB_OUTPUT"