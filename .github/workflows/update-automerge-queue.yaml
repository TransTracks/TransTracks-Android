name: Update Auto-merge Queue

env:
  BUILD_NUMBER: ${{ github.run_number }}

on:
  pull_request:
    types: [auto_merge_enabled]
  push:

jobs:

  get-prs:
    runs-on: ubuntu-latest
    outputs:
      pr_ids: ${{ steps.prs.outputs.pr_list_json.items.*.properties.number }}

    steps:
      - name: 🚚 Checkout PR
        uses: actions/checkout@v3

      - name: 📝 Get open prs
        id: prs
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          API_URL: https://api.github.com/${{ github.repository_owner }}/repos/${{ github.repository }}/pulls?state=open
        run: |
          pr_list_json=$(curl -L -s -S -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $TOKEN" -H "X-GitHub-Api-Version: 2022-11-28") "$API_URL"
          echo "pr_list_json=$pr_list_json" >> "$GITHUB_OUTPUT"

      - name: Filter to those with automerge details
        env:
          pr_list_json: ${{ steps.prs.outputs.pr_list_json.items }}
        run: |
          echo "automerge_pr_list_json=$(echo \"$pr_list_json\" | jq -c 'select( .auto_merge )')" >> "$GITHUB_OUTPUT"