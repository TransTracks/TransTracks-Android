name: Update Auto-merge Queue

env:
  BUILD_NUMBER: ${{ github.run_number }}

on:
  pull_request:
    types: [auto_merge_enabled]
  push:

jobs:

  get-prs:
    runs-on: ubuntu-latest

    steps:
      - name: 🚚 Checkout PR
        uses: actions/checkout@v3

      - name: 📝 Get open prs
        id: prs
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          API_URL: https://api.github.com/${{ github.repository_owner }}/repos/${{ github.repository }}/pulls?state=open
        run: |
          prList=$(curl -L -s -S -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $TOKEN" -H "X-GitHub-Api-Version: 2022-11-28" $API_URL) 
          echo "pr-list=$prList" >> "$GITHUB_OUTPUT"

      - name: Filter to those with automerge details
        env:
          PR_LIST_JSON: ${{ steps.prs.outputs.pr-list.items }}
        run: |
          autoMergePrList=$(echo "$PR_LIST_JSON" | jq -c 'select( .auto_merge )')
          echo "automerge-pr-list=$autoMergePrList" >> "$GITHUB_OUTPUT"